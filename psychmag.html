<!DOCTYPE html>
<html>
  <head>
    <title>Magnitude pilot experiment</title>
    <script src="https://unpkg.com/jspsych"></script>
    <script src="https://unpkg.com/@jspsych/plugin-external-html"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-button-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-button-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <link href="https://unpkg.com/jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
    <script src="canvasMorpher.js"></script>


    <link href="https://unpkg.com/jspsych/css/jspsych.css" rel="stylesheet" type="text/css" />

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      .jspsych-btn { padding: 1px 20px;
      font-size: 20px;
      border-color: black;
      }
    </style>

  </head>
  <body></body>

  <script>

  //To do:
  //Provide condition differences for Block 3 (see line 625 in createExperiment function)
  //Provide randomization of A, B label (see line 208)
  //Ling: save A/B randomization condition in data

  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    show_progress_bar: true,
  });

  var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
  };

  var SONAID = getUrlParameter('id');
  var subjectID = SONAID;
  if (subjectID===undefined) {subjectID = this.jsPsych.randomization.randomID(8)}; //if ID isn't read in, best to give it a random value
  jsPsych.data.addProperties({subject_id: subjectID}); //this is the awkward way you need to call jspsych routines now!
  var check_consent = function(elem) {
    if (document.getElementById('consent_checkbox').checked) {
      return true;
    }
    else {
      alert("Please check the box next to the statement 'I agree to participate in this study.' if you wish to continue.");
      return false;
    }
    return false;
  };

  var consentTrial = {
    type:jsPsychExternalHtml,
    url: "https://lingsyrina.github.io/consent.html",
    cont_btn: "start",
    check_fn: check_consent
  };

    /* Instructions */
    /* welcome message */
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p style="font-size:20px;font-weight:bold;"> Thank you for your participation! </p> <p> Press any key to begin.</p>`
    };

    /* closing message */
    var closing = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p> Thank you very much again for your participation! We sincerely appreciate your time and effort.</p> <p>You can close your window whenever you feel comfortable.</p>"
    };

    /* instruction for learning phase_1 */
    // Passive learning
    var instruction_1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> In this section, <br />
        You will <strong>compare pairs of images </strong> which appear in the center of the screen.<br />
        Below each image will be <strong> a statement that describes it</strong>. <br/>
        <p> (Press any key to begin) </p>
      `,
      post_trial_gap: 500
    };

    // Active learning
    var instruction_2 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> In this section, <br />
        you will continue to <strong>compare pairs of images</strong>. <br/>
        However, you will now be asked to <strong>choose the correct description</strong> for the <strong>image on the right/strong>.</p>
        (Press any key to continue)
      `,
      /* I am deliberately not telling them that they will be given limitless chances until they get it right -- just so they can pay more attention.*/
      post_trial_gap: 500
    };

    /* instruction for testing phase_1 */
    var instruction_3 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> <strong>Great Job!</strong> </p>
        <p> Continue answering our questions by <strong>selecting the correct description</strong> for the <strong>image on the right</strong>.</br> However, we are no longer telling you whether you\`ve got the right answer or not!</p>
        <p> (Press any key to continue)</p>
      `,
      post_trial_gap: 500
    };

    /* instruction for learning phase_2 */
    //Passive
    var instruction_4 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> <strong>Perfect!</strong> </p>
        <p> You will continue to see pairs of images accompanied by the description.
        <br/> This time, we are giving you more detailed description, using <strong>our own mysterious scale</strong>... </p>
        <p>(Press any key to continue)</p>
      `,
      post_trial_gap: 500
    };

    //Active
    var instruction_5 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> <strong>Awesome!</strong> <br/>
        Now, we would like to ask you to choose the <strong>correct statement for the image on the right</strong>.</p>
        Press any key to continue.
      `,
      post_trial_gap: 500
    };

    /* instruction for testing phase_2a */
    var instruction_6 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> <strong>Great Job!</strong> </p>
        <p> We're going to give you another set of questions.<br/> However, we are <strong>no longer</strong> telling you whether you\`ve got the right answer or not!</p>
        <p> Press any key to continue.</p>
      `,
      post_trial_gap: 500
    };

    /* instruction for testing phase_2b */
    var instruction_7 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> <strong>Excellent!</strong> </p>
        <p> We're going to give you one last set of questions.<br/> You will continue to <strong>compare pairs of images</strong> and <strong>choose the correct description</strong> for the <strong>image on the right</strong>!</p>
        <p> Press any key to continue.</p>
      `,
      post_trial_gap: 500
    };

    /* instruction for testing phase_2b */
    var instruction_8 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> <strong>Great job!</strong> </p>
        <p> This is the last part of the experiment.<br/> This time you will be seeing <strong>different descriptions with familiar concepts </strong>. Choose the best one!</p>
        <p> Press any key to continue.</p>
      `,
      post_trial_gap: 500
    };

     /* Fixation */
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div style="font-size:60px;">+</div>`,
      choices: "NO_KEYS",
      trial_duration: 500,
      data: {
        task: `fixation`
      }
    };
    var instruction_break = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p style="font-size:20px;font-weight:bold;"> Look at this pair! </p>
        <p> (Press any key when you are ready)</p>
      `,
    };


    // frimble vs. orpital
    var A = `frimble`;
    var B = `orpital`;

    /* Stimuli : low precision condition */
    /* Stimuli for learning_phase_1A */
    var learn_stimuli_a1 = [
        { stimulus: "1", radius_a: .05, name_a: `Compared to this...<br/> .`, radius_b: .80, prompt: `<p style="font-size:20px;"> Compared to the left one, <strong>the right one is more ${B}</strong>.</p> <br /> (Press any key to continue to the next image)` },
        { stimulus: "2", radius_a: .95, name_a: `Compared to this...<br/> .`,radius_b: .35, prompt:  `<p style="font-size:20px;"> Compared to the left one, <strong>the right one is more ${A}</strong>.</p> <br /> (Press any key to continue to the next image)` },
        { stimulus: "3", radius_a: .10,name_a: `Compared to this...<br/> .`,radius_b: .55, prompt:  `<p style="font-size:20px;"> Compared to the left one, <strong>the right one is more ${B}</strong>.</p> <br /> (Press any key to continue to the next image)` },
        { stimulus: "4", radius_a: .35,name_a: `Compared to this...<br/> .`,radius_b: .20, prompt:  `<p style="font-size:20px;"> Compared to the left one, <strong>the right one is more ${A}</strong>.</p> <br /> (Press any key to continue to the next image)` },
        { stimulus: "5", radius_a: .55,name_a: `Compared to this...<br/> .`,radius_b: .55, prompt: `<p style="font-size:20px;font-weight:bold;"> They are equal. </p><br /> (Press any key to continue to the next image)` },
      ];
    /* Stimuli for learning_phase_1B */
    var learn_stimuli_a2 = [
        { stimulus: "6", radius_a: .30,name_a: `Compared to this...`,radius_b: .90, prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` , correct_response:'p' },
        { stimulus: "7", radius_a: .20,name_a: `Compared to this...`,radius_b: .20, prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` ,correct_response:'p'},
        { stimulus: "8", radius_a: .25,name_a: `Compared to this...`,radius_b: .10, prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` ,correct_response:'q' },
        { stimulus: "9", radius_a: .30,name_a: `Compared to this...`,radius_b: .75, prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` ,correct_response:'p' },
        { stimulus: "10", radius_a: .90,name_a: `Compared to this...`,radius_b: .30, prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` ,correct_response:'q' },
      ];

    /* Stimuli for learning_phase_1B */
    var learn_stimuli_c1 = [
        { stimulus: "1", radius_a: .05, name_a: `Compared to this...<br/> .`, radius_b: .80, prompt: `<p style="font-size:20px;">Compared to the left one, <strong>the right one is 5 degree(s) more ${B}</strong>. </p><br />(Press any key to continue to the next image)` },//75
        { stimulus: "3", radius_a: .10,name_a: `Compared to this...<br/> .`,radius_b: .55, prompt: `<p style="font-size:20px;">Compared to the left one, <strong>the right one is 3 degree(s) more ${B}</strong>. </p><br />(Press any key to continue to the next image)`},//45
        { stimulus: "4", radius_a: .35,name_a: `Compared to this...<br/> .`,radius_b: .20, prompt: `<p style="font-size:20px;">Compared to the left one, <strong>the right one is 1 degree(s) more ${B}</strong>. </p><br />(Press any key to continue to the next image)` },//15
        { stimulus: "2", radius_a: .95, name_a: `Compared to this...<br/> .`,radius_b: .35, prompt: `<p style="font-size:20px;">Compared to the left one, <strong>the right one is 4 degree(s) more ${B}</strong>. </p><br />(Press any key to continue to the next image)` },//60
        { stimulus: "5", radius_a: .55,name_a: `Compared to this...<br/> .`,radius_b: .55, prompt: `<p style="font-size:20px;font-weight:bold;">They are equal. </p><br />(Press any key to continue to the next image)` },//0
      ];
   var learn_stimuli_c2 = [
        { stimulus: "6", radius_a: .30,name_a: `Compared to this...`,radius_b: .90, prompt: `<p style="font-size:20px;"><strong>From 0 to 4</strong>, how many degree(s) is <strong>the right one more ${B}</strong>?</br>(Use number keys)</p>`, correct_response:4 },//60
        { stimulus: "7", radius_a: .20,name_a: `Compared to this...`,radius_b: .20, prompt: `<p style="font-size:20px;"><strong>From 0 to 4</strong>, how many degree(s) is <strong>the right one more ${B}</strong>?</br>(Use number keys)</p>`,correct_response:0},//0
        { stimulus: "8", radius_a: .25,name_a: `Compared to this...`,radius_b: .10, prompt: `<p style="font-size:20px;"><strong>From 0 to 4</strong>, how many degree(s) is <strong>the right one more ${A}</strong>?</br>(Use number keys)</p>`,correct_response:1 },//15
        { stimulus: "9", radius_a: .30,name_a: `Compared to this...`,radius_b: .75, prompt: `<p style="font-size:20px;"><strong>From 0 to 4</strong>, how many degree(s) is <strong>the right one more ${B}</strong>?</br>(Use number keys)</p>`,correct_response:3},//45
        { stimulus: "10", radius_a: .90,name_a: `Compared to this...`,radius_b: .30, prompt: `<p style="font-size:20px;"><strong>From 0 to 4</strong>, how many degree(s) is <strong>the right one more ${A}</strong>?</br>(Use number keys)</p>`,correct_response:4},//60
      ];

    /* Stimuli for testing_phase */
    var test_stimuli = [
      { stimulus: "1", radius_a: .05, prompt: `Compared to this...`, radius_b: .80, key_prompt: `Compared to this, this is more B.`, correct_response:1  , prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`},
      { stimulus: "2", radius_a: .95, prompt: `Compared to this...`,radius_b: .35, key_prompt: `Compared to this, this is more A.` , correct_response:0 , prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`},
      { stimulus: "3", radius_a: .10,prompt: `Compared to this...`,radius_b: .55, key_prompt: `Compared to this, this is more B.` , correct_response:1 ,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`},
      { stimulus: "4", radius_a: .35,prompt: `Compared to this...`,radius_b: .20, key_prompt: `Compared to this, this is more A.` ,correct_response:0,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
      { stimulus: "5", radius_a: .55,prompt: `Compared to this...`,radius_b: .55, key_prompt: `They are equal.` ,correct_response:2,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
      { stimulus: "6", radius_a: .30,prompt: `Compared to this...`,radius_b: .90, key_prompt: `Compared to this, this is more B.`, correct_response:1,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
      { stimulus: "7", radius_a: .20,prompt: `Compared to this...`,radius_b: .20, key_prompt: `They are equal.`,correct_response:2,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
      { stimulus: "8", radius_a: .25,prompt: `Compared to this...`,radius_b: .10, key_prompt: `Compared to this, this is more A.`,correct_response:0 ,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
      { stimulus: "9", radius_a: .30,prompt: `Compared to this...`,radius_b: .75, key_prompt: `Compared to this, this is more B.`,correct_response:1 ,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
      { stimulus: "10", radius_a: .90,prompt: `Compared to this...`,radius_b: .30, key_prompt: `Compared to this, this is more A.`,correct_response:0,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
      ];

      var test_stimuli_2 = [
        { stimulus: "1", radius_a: .05, prompt: `Compared to this...`, radius_b: .80, key_prompt: `Compared to this, this is more B.`, correct_response:1,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
        { stimulus: "2", radius_a: .95, prompt: `Compared to this...`,radius_b: .35, key_prompt: `Compared to this, this is more A.` , correct_response:0,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
        { stimulus: "3", radius_a: .10,prompt: `Compared to this...`,radius_b: .55, key_prompt: `Compared to this, this is more B.` , correct_response:1 ,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
        { stimulus: "4", radius_a: .35,prompt: `Compared to this...`,radius_b: .20, key_prompt: `Compared to this, this is more A.` ,correct_response:0 ,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
        { stimulus: "5", radius_a: .55,prompt: `Compared to this...`,radius_b: .55, key_prompt: `They are equal.` ,correct_response:2,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
        { stimulus: "6", radius_a: .30,prompt: `Compared to this...`,radius_b: .90, key_prompt: `Compared to this, this is more B.`, correct_response:1,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
        { stimulus: "7", radius_a: .20,prompt: `Compared to this...`,radius_b: .20, key_prompt: `They are equal.`,correct_response:2,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
        { stimulus: "8", radius_a: .25,prompt: `Compared to this...`,radius_b: .10, key_prompt: `Compared to this, this is more A.`,correct_response:0,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`  },
        { stimulus: "9", radius_a: .30,prompt: `Compared to this...`,radius_b: .75, key_prompt: `Compared to this, this is more B.`,correct_response:1,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>` },
        { stimulus: "10", radius_a: .90,prompt: `Compared to this...`,radius_b: .30, key_prompt: `Compared to this, this is more A.`,correct_response:0 ,prompt: `<p style="font-size:20px;"> The right image is...</br> <strong>Q</strong>: more <strong>${A}</strong>.&emsp;&emsp; <strong>P</strong>: more <strong>${B}</strong>.</p>`},
        ];

        var test_stimuli_3 = [
          { stimulus: 'img/tall1.png', word: "tall", antonym: "short"},
          { stimulus: 'img/tall2.png', word: "tall", antonym: "short"},
          { stimulus: 'img/tall3.png', word: "tall", antonym: "short"},
          { stimulus: 'img/dark1.png', word: "dark", antonym: "light"},
          { stimulus: 'img/dark2.png', word: "dark", antonym: "light"},
          { stimulus: 'img/dark3.png', word: "dark", antonym: "light"},
          ];


    // /* Function for generating canvas stimuli */
    // function Morphfunction(canvas, p1, p2){
    //     const canvasMorpher = new CanvasMorpher(canvas, 80, 138);
    //     canvasMorpher.combineImages(canvas, p1, p2);
    // }


    /* Function for generating canvas stimuli */
    function Morphfunction(canvas, p1, p2, n1=0, n2=0) {
      return new Promise((resolve) => {
        const canvasMorpher = new CanvasMorpher(canvas, 80, 138);
        canvasMorpher.combineImages(canvas, p1, p2, n1, n2, () => {
          resolve();
        });
      });
    }

    /* Function for generating canvas stimuli */
    function XAB_test(canvas, p1, p2, n1=0, n2=0) {
      return new Promise((resolve) => {
        const canvasMorpher = new CanvasMorpher(canvas, 80, 138);
        canvasMorpher.XAB(canvas, p1, p2, n1, n2, () => {
          resolve();
        });
      });
    }

/* Experiment procedures */

    var pre_test = {
       type: jsPsychCanvasKeyboardResponse,
       canvas_size: [600, 600],
       stimulus: async function(c) {
         await XAB_test(c, jsPsych.timelineVariable('radius_a'), jsPsych.timelineVariable('radius_b'));
         return c;
       },
       choices: ['q', 'p'],
       prompt: "<p>Which image is the same as the one on top? </br> Press '<strong>Q</strong>' for left; '<strong>P</strong>' for right.</p>",
       response_ends_trial: true,
       data: {
               task: `test_response`,
               correct_response: jsPsych.timelineVariable(`correct_response`),
               stimuli_1: (jsPsych.timelineVariable(`radius_a`)),
               stimuli_2: (jsPsych.timelineVariable(`radius_b`)),
           },
      on_finish: function(data){
                   // Score the response as correct or incorrect.
                   if(jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
                     data.wrong = false;
                   } else {
                     data.wrong = true;
                   }
       }
     };

    /* block1: learning task */
    /* 1.1 learning: define learning trials*/
    var learn_A_passive = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [400, 900],
        stimulus: async function(c) {
          await Morphfunction(c, jsPsych.timelineVariable('radius_a'), jsPsych.timelineVariable('radius_b'));
          return c;
        },
        prompt: jsPsych.timelineVariable(`prompt`),
        data: {
                stimuli_1: jsPsych.timelineVariable(`radius_a`),
                stimuli_2: jsPsych.timelineVariable(`radius_b`)
            },
      };

     var learn_A_active = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [400, 900],
        stimulus: async function(c) {
          await Morphfunction(c, jsPsych.timelineVariable('radius_a'), jsPsych.timelineVariable('radius_b'));
          return c;
        },
        response_ends_trial: true,
        data: {
                task: `block1_active_response`,
                stimuli_1: jsPsych.timelineVariable(`radius_a`),
                stimuli_2: jsPsych.timelineVariable(`radius_b`),
                correct_response: jsPsych.timelineVariable(`correct_response`)
            },
        choices: ['q', 'p'],
        prompt: jsPsych.timelineVariable(`prompt`),
        on_finish: function(data){
                         // Score the response as correct or incorrect.
                         if(jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
                           data.wrong = false;
                         } else {
                           data.wrong = true;
                         }
        }
      };

      var looped_A_active = {
        timeline: [learn_A_active],
        loop_function: function(data){
          if (jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
            alert(`Nope, let\`s try again!`);
            return true;
            //jsPsych.resumeExperiment(learn_A_2b); // Resume the experiment
          } else{
            alert(`Yes! Great job!`);
            return false;
          }
        }
      };

      var test = {
         type: jsPsychCanvasKeyboardResponse,
         canvas_size: [400, 900],
         stimulus: async function(c) {
           await Morphfunction(c, jsPsych.timelineVariable('radius_a'), jsPsych.timelineVariable('radius_b'));
           return c;
         },
         response_ends_trial: true,
         data: {
                 task: `test_response`,
                 correct_response: jsPsych.timelineVariable(`correct_response`),
                 stimuli_1: (jsPsych.timelineVariable(`radius_a`)),
                 stimuli_2: (jsPsych.timelineVariable(`radius_b`)),
             },

        choices: ['q', 'p'],
        prompt: jsPsych.timelineVariable(`prompt`),
        on_finish: function(data){
                     // Score the response as correct or incorrect.
                     if(jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
                       data.wrong = false;
                     } else {
                       data.wrong = true;
                     }
         }
       };

       var learn_C_active = {
          type: jsPsychCanvasKeyboardResponse,
          canvas_size: [400, 900],
          stimulus: async function(c) {
            await Morphfunction(c, jsPsych.timelineVariable('radius_a'), jsPsych.timelineVariable('radius_b'));
            return c;
          },
          prompt: jsPsych.timelineVariable(`prompt`),
          response_ends_trial: true,
          data: {
                  task: `block2_active_response`,
                  correct_response: jsPsych.timelineVariable(`correct_response`),
                  stimuli_1: (jsPsych.timelineVariable(`radius_a`)),
                  stimuli_2: (jsPsych.timelineVariable(`radius_b`)),
              },
          on_finish: function(data){
                  // Score the response as correct or incorrect.
                  if(jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
                    data.wrong = false;
                  } else {
                    data.wrong = true;
                  }
                }
        };

        var looped_C_active = {
          timeline: [learn_C_active],
          loop_function: function(data){
            if(jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
              alert(`Nope, let\`s try again!`);
              return true;
              //jsPsych.resumeExperiment(learn_A_2b); // Resume the experiment
            } else{
              alert(`Yes! Great job!`);
              return false;
            }
          }
        };

        var test_equally = {
           type: jsPsychCanvasKeyboardResponse,
           canvas_size: [400, 900],
           stimulus: async function(c) {
             await Morphfunction(c, jsPsych.timelineVariable('radius_a'), jsPsych.timelineVariable('radius_b'));
             return c;
           },
           response_ends_trial: true,
           data: {
                   task: `test_response`,
                   correct_response: jsPsych.timelineVariable(`correct_response`),
                   stimuli_1: (jsPsych.timelineVariable(`radius_a`)),
                   stimuli_2: (jsPsych.timelineVariable(`radius_b`)),
               },


          choices: ['q', 'p'],
          prompt: jsPsych.timelineVariable(`prompt`),
          on_finish: function(data){
                       // Score the response as correct or incorrect.
                       if(jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
                         data.wrong = false;
                       } else {
                         data.wrong = true;
                       }
           }
         };

         var real_adj = {
             type: jsPsychImageButtonResponse,
             stimulus: jsPsych.timelineVariable(`stimulus`),
             stimulus_height: 400,
             choices: function() {
               var word = jsPsych.timelineVariable('word');
               var antonym = jsPsych.timelineVariable('antonym');
               return [
                  `The right one is ${word}er.`,
                  `The right one is ${antonym}.`,
                  `They are equally ${word}.`,
                  `They are equally ${antonym}.`
                ];
            },
         };



      /* define learning procedure*/
      var pre_test_xab = {
        timeline: [instruction_break, pre_test],
        timeline_variables:test_stimuli,
      };
      // Block I: learning (passive + active)
      var learn_procedure_1 = {
        timeline: [instruction_break, learn_A_passive],
        timeline_variables:learn_stimuli_a1,
      };
      var learn_procedure_2 = {
        timeline: [instruction_break,looped_A_active],
        timeline_variables: learn_stimuli_a2,
        randomize_order: true,
      };
      // Block II: testing
      var test_procedure_1 = {
         timeline: [instruction_break, test],
         timeline_variables: test_stimuli,
         randomize_order: true,
       };
       // Block III: learning (passive + active)
       var learn_procedure_3 = {
         timeline: [instruction_break, learn_A_passive],
         timeline_variables:learn_stimuli_c1,
       };

       var learn_procedure_4 = {
         timeline: [instruction_break,looped_C_active],
         timeline_variables: learn_stimuli_c2,
         randomize_order: true,
       };
       // Block IV: testing
       var test_procedure_2 = {
          timeline: [instruction_break, test],
          timeline_variables: test_stimuli,
          randomize_order: true,
        };

      var test_procedure_3 = {
           timeline: [instruction_break, test_equally],
           timeline_variables: test_stimuli_2,
           randomize_order: true,
         };

     var survey = {
       timeline: [instruction_break, real_adj],
       timeline_variables: test_stimuli_3,
       randomize_order: true,
     }

    // save to OFS server (check documentation)
    //  var save_server_data = {
    //   type: jsPsychCallFunction,
    //   func: function () {
    //     var data = jsPsych.data.get().ignore("internal_node_id").json();//ommitting .filter({task: 'property'}) to include all trials
    //     var xhr = new XMLHttpRequest();
    //     xhr.open('POST', 'php/save_json.php');
    //     xhr.setRequestHeader('Content-Type', 'application/json');
    //     xhr.send(JSON.stringify({ filedata: data }));
    //     jsPsychPipe.save(experiment_id, filename, data)
    //   },
    //   post_trial_gap: 1000
    // }

    const expID = "iPtLEVGIdxPA";
    let condition;

    const save_server_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: expID,
      filename: () => `${condition}_${subjectID}.csv`,
      data_string: ()=>jsPsych.data.get().csv(),
      post_trial_gap: 1000
    };

    async function getCondition() {
      try {
        const response = await jsPsychPipe.getCondition(expID);
        console.log('Response:', response); // Log the response to confirm

        // Check if the response is a valid condition number
        if (typeof response === 'number') {
          return response;
        } else {
          throw new Error('Invalid response format');
        }
      } catch (error) {
        console.error('Failed to get condition:', error);
      }
    }


    async function createExperiment() {
      condition = await getCondition();

      var timeline_h = [];
      var timeline_l = [];

      timeline_h.push(welcome, consentTrial);
      timeline_l.push(welcome, consentTrial);

      /*block1: Same across all groups*/
      timeline_h.push(pre_test_xab);
      timeline_l.push(pre_test_xab);
      timeline_h.push(instruction_1);
      timeline_l.push(instruction_1);
      timeline_h.push(learn_procedure_1);
      timeline_l.push(learn_procedure_1);
      timeline_h.push(instruction_2);
      timeline_l.push(instruction_2);
      timeline_h.push(learn_procedure_2);
      timeline_l.push(learn_procedure_2);

      /*block2: Same across all groups*/
      timeline_h.push(instruction_3);
      timeline_l.push(instruction_3);
      timeline_h.push(test_procedure_1);
      timeline_l.push(test_procedure_1);

      /*block3: Constrast between two groups*/
      /*High precision group*/
      timeline_h.push(instruction_4);
      timeline_h.push(learn_procedure_3);
      timeline_h.push(instruction_5);
      timeline_h.push(learn_procedure_4);
      /*Low precision group*/
      timeline_l.push(instruction_4);
      timeline_l.push(learn_procedure_3);
      timeline_l.push(instruction_5);
      timeline_l.push(learn_procedure_4);

      /*block4: Same across all groups*/
      timeline_h.push(instruction_6);
      timeline_h.push(test_procedure_2);
      timeline_h.push(instruction_7);
      timeline_h.push(test_procedure_3);
      timeline_l.push(instruction_6);
      timeline_l.push(test_procedure_2);
      timeline_l.push(instruction_7);
      timeline_l.push(test_procedure_3);

      /*survey: Same across all groups*/
      //Follow-up trial with real adjectives
      timeline_h.push(instruction_8);
      timeline_h.push(survey);
      timeline_l.push(instruction_8);
      timeline_l.push(survey);

      /*save_data: Same across all groups*/
      timeline_h.push(closing);
      timeline_h.push(save_server_data);
      timeline_l.push(closing);
      timeline_l.push(save_server_data);

      if(condition==0){
        jsPsych.run(timeline_h)
      } else {
        jsPsych.run(timeline_l)
      }
    }

  createExperiment();


  </script>
</html>

