<!DOCTYPE html>
<html>
  <head>
    <title>Magnitude pilot experiment</title>
    <script src="https://unpkg.com/jspsych"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-button-response"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
    <script src="canvasMorpher.js"></script>

    <link href="https://unpkg.com/jspsych/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">        
  </head>
  <body></body>

  <script>
    
  /* initialize jsPsych */
  var jsPsych = initJsPsych({
    on_finish: function() {
      var json = jsPsych.data.get().json();
      var filename = "Englishtrial.json";
      downloadJson(json,filename);
      jsPsych.data.displayData();
    }
  });

    /* Instructions */
    /* welcome message */
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p> Thank you for your participation! </p> <p></p> <p> Press any key to begin </p>"
    };

    /* instruction for learning phase_1 */
    // Passive learning
    var instruction_1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> In this section, a pair of objects will appear in the center of the screen.</p>
        <p> Below is a statement that describes the image. </p>
        <p> <strong> Once you've finished reading, press any key to continue to the next image. </strong> </p>
        <p> Press any key to begin. </p>
      `,
      post_trial_gap: 500
    };
    
    // Active learning
    var instruction_2 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> Active learning. </p>
      `,
      post_trial_gap: 500
    };
    
    /* instruction for testing phase_1 */
    var instruction_3 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> Pre training testing. </p>
      `,
      post_trial_gap: 500
    };
    
    /* instruction for learning phase_2 */
    //Passive
    var instruction_4 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> Passive learning </p>
      `,
      post_trial_gap: 500
    };

    //Active
    var instruction_5 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> Active learning.</p>
      `,
      post_trial_gap: 500
    };

    /* instruction for testing phase_2 */
    var instruction_6 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> Final testing </p>
      `,
      post_trial_gap: 500
    };

     /* Fixation */
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: "NO_KEYS",
      trial_duration: 500, 
      data: {
        task: 'fixation'
      } 
    };
    var instruction_break = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <p> Look at this pair! </p>
        <p> (press any key when you are ready) </p> 
      `,
    };

    

    /* Stimuli */
    /* Stimuli for learning_phase_1A */
    var learn_stimuli_a1 = [
        { stimulus: "1", radius_a: .05, name_a: 'Compared to this...', radius_b: .80, name_b: 'This is more B' },
        { stimulus: "2", radius_a: .95, name_a: 'Compared to this...',radius_b: .35, name_b: 'This is more A' },
        { stimulus: "3", radius_a: .10,name_a: 'Compared to this...',radius_b: .55, name_b: 'This is more B' },
        { stimulus: "4", radius_a: .35,name_a: 'Compared to this...',radius_b: .20, name_b: 'This is more A' },
        { stimulus: "5", radius_a: .55,name_a: 'Compared to this...',radius_b: .55, name_b: 'They are equal' },
      ];
    /* Stimuli for learning_phase_1B */
    var learn_stimuli_a2 = [
        { stimulus: "6", radius_a: .30,name_a: 'Compared to this...',radius_b: .90, name_b: 'This is more B', correct_response:1 },
        { stimulus: "7", radius_a: .20,name_a: 'Compared to this...',radius_b: .20, name_b: 'They are equal',correct_response:2},
        { stimulus: "8", radius_a: .25,name_a: 'Compared to this...',radius_b: .10, name_b: 'This is more A',correct_response:0 },
        { stimulus: "9", radius_a: .30,name_a: 'Compared to this...',radius_b: .75, name_b: 'This is more B',correct_response:1 },
        { stimulus: "10", radius_a: .90,name_a: 'Compared to this...',radius_b: .30, name_b: 'This is more A',correct_response:0 },
      ];

    var test_stimuli_1 = [
      { stimulus: "1", radius_a: .05, name_a: 'Compared to this...', radius_b: .80, name_b: 'This is more B', correct_response:1  },
      { stimulus: "2", radius_a: .95, name_a: 'Compared to this...',radius_b: .35, name_b: 'This is more A' , correct_response:0 },
      { stimulus: "3", radius_a: .10,name_a: 'Compared to this...',radius_b: .55, name_b: 'This is more B' , correct_response:1 },
      { stimulus: "4", radius_a: .35,name_a: 'Compared to this...',radius_b: .20, name_b: 'This is more A' ,correct_response:0 },
      { stimulus: "5", radius_a: .55,name_a: 'Compared to this...',radius_b: .55, name_b: 'They are equal' ,correct_response:2 },
      { stimulus: "6", radius_a: .30,name_a: 'Compared to this...',radius_b: .90, name_b: 'This is more B', correct_response:1 },
      { stimulus: "7", radius_a: .20,name_a: 'Compared to this...',radius_b: .20, name_b: 'They are equal',correct_response:2},
      { stimulus: "8", radius_a: .25,name_a: 'Compared to this...',radius_b: .10, name_b: 'This is more A',correct_response:0 },
      { stimulus: "9", radius_a: .30,name_a: 'Compared to this...',radius_b: .75, name_b: 'This is more B',correct_response:1 },
      { stimulus: "10", radius_a: .90,name_a: 'Compared to this...',radius_b: .30, name_b: 'This is more A',correct_response:0 },
      ];
    /* Stimuli for learning_phase_1B */
    var learn_stimuli_c1 = [
        { stimulus: "1", radius_a: .05, name_a: 'Compared to this...', radius_b: .80, name_b: 'This is 5 degrees more B' },//75
        { stimulus: "3", radius_a: .10,name_a: 'Compared to this...',radius_b: .55, name_b: 'This is 3 degrees more B' },//45
        { stimulus: "4", radius_a: .35,name_a: 'Compared to this...',radius_b: .20, name_b: 'This is 1 degrees more A' },//15
        { stimulus: "2", radius_a: .95, name_a: 'Compared to this...',radius_b: .35, name_b: 'This is 4 degrees more A' },//60
        { stimulus: "5", radius_a: .55,name_a: 'Compared to this...',radius_b: .55, name_b: 'They are equal' },//0
      ];
   var learn_stimuli_c2 = [
        { stimulus: "6", radius_a: .30,name_a: 'Compared to this...',radius_b: .90, name_b: 'From 0 to 4, how many degrees is this more B?', correct_response:'4' },//60
        { stimulus: "7", radius_a: .20,name_a: 'Compared to this...',radius_b: .20, name_b: 'From 0 to 4, how many degrees is this more B?',correct_response:'0'},//0
        { stimulus: "8", radius_a: .25,name_a: 'Compared to this...',radius_b: .10, name_b: 'From 0 to 4, how many degrees is this more A?',correct_response:'1' },//15
        { stimulus: "9", radius_a: .30,name_a: 'Compared to this...',radius_b: .75, name_b: 'From 0 to 4, how many degrees is this more B?',correct_response:'3'},//45
        { stimulus: "10", radius_a: .90,name_a: 'Compared to this...',radius_b: .30, name_b: 'From 0 to 4, how many degrees is this more A?',correct_response:'4'},//60
      ];
    /* Stimuli for learning_phase_1B */
    var test_stimuli_2 = [
        { stimulus: "1", radius_a: .05, name_a: 'Compared to this...', radius_b: .80, name_b: 'This is more B', correct_response:1  },
        { stimulus: "2", radius_a: .95, name_a: 'Compared to this...',radius_b: .35, name_b: 'This is more A' , correct_response:0 },
        { stimulus: "3", radius_a: .10,name_a: 'Compared to this...',radius_b: .55, name_b: 'This is more B' , correct_response:1 },
        { stimulus: "4", radius_a: .35,name_a: 'Compared to this...',radius_b: .20, name_b: 'This is more A' ,correct_response:0 },
        { stimulus: "5", radius_a: .55,name_a: 'Compared to this...',radius_b: .55, name_b: 'They are equal' ,correct_response:2 },
        { stimulus: "6", radius_a: .30,name_a: 'Compared to this...',radius_b: .90, name_b: 'This is more B', correct_response:1 },
        { stimulus: "7", radius_a: .20,name_a: 'Compared to this...',radius_b: .20, name_b: 'They are equal',correct_response:2},
        { stimulus: "8", radius_a: .25,name_a: 'Compared to this...',radius_b: .10, name_b: 'This is more A',correct_response:0 },
        { stimulus: "9", radius_a: .30,name_a: 'Compared to this...',radius_b: .75, name_b: 'This is more B',correct_response:1 },
        { stimulus: "10", radius_a: .90,name_a: 'Compared to this...',radius_b: .30, name_b: 'This is more A',correct_response:0 },
      ];
    
    /* Function for generating canvas stimuli */
    function Morphfunction(canvas,p){
        const canvasMorpher = new CanvasMorpher(canvas, 80, 138);
        canvasMorpher.morphAndDraw(p);
    }   

/* Experiment procedures */
    /* block1: learning task */
    /* 1.1 learning: define learning trials*/
    var learn_A_1a = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [300, 300],
        stimulus: function(c) {
            Morphfunction(c, jsPsych.timelineVariable('radius_a'));
        },
        prompt: jsPsych.timelineVariable('name_a'),
        choices: "NO_KEYS",
        trial_duration: 2000,
        data: {
                radius: jsPsych.timelineVariable('radius_a'),
                prompt: jsPsych.timelineVariable('name_a'),
            },
      };

    var learn_A_1b = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [300, 300],
        stimulus: function(c) {
            Morphfunction(c, jsPsych.timelineVariable('radius_b'));
        },
        prompt: jsPsych.timelineVariable('name_b'),
        data: {
                radius: jsPsych.timelineVariable('radius_b'),
                prompt: jsPsych.timelineVariable('name_b'),
            },
      };

     var learn_A_2a = {
        type: jsPsychCanvasKeyboardResponse,
        canvas_size: [300, 300],
        stimulus: function(c) {
            Morphfunction(c, jsPsych.timelineVariable('radius_a'));
        },
        prompt: jsPsych.timelineVariable('name_a'),
        choices: "NO_KEYS",
        trial_duration: 2000,
        data: {
                radius: jsPsych.timelineVariable('radius_a'),
                prompt: jsPsych.timelineVariable('name_a')
            },
      };

     var learn_A_2b = {
        type: jsPsychCanvasButtonResponse,
        canvas_size: [300, 300],
        choices: ['a', 'b', 'c'],
        button_html: ['This is more A', 'This is more B', 'They are the same'],
        stimulus: function(c) {
            Morphfunction(c, jsPsych.timelineVariable('radius_b'));
        },
        response_ends_trial: true,
        data: {
                task: 'response',
                correct_response: jsPsych.timelineVariable('correct_response')
            },
      };

      var looped_A_2 = {
        timeline: [learn_A_2a, learn_A_2b],
        loop_function: function(data){
          if (jsPsych.data.get().last(1).values()[0].response != jsPsych.data.get().last(1).values()[0].correct_response){
            alert('Nah, let us try again!');
            return true;
            //jsPsych.resumeExperiment(learn_A_2b); // Resume the experiment
          } else{
            alert('Yes! Great job!');
            return false;
          }
        }
      };

      var test_a = {
         type: jsPsychCanvasKeyboardResponse,
         canvas_size: [300, 300],
         stimulus: function(c) {
             Morphfunction(c, jsPsych.timelineVariable('radius_a'));
         },
         prompt: jsPsych.timelineVariable('name_a'),
         choices: "NO_KEYS",
         trial_duration: 2000,
         data: {
                 radius: jsPsych.timelineVariable('radius_a'),
                 prompt: jsPsych.timelineVariable('name_a')
             },
       };

      var test_b = {
         type: jsPsychCanvasButtonResponse,
         canvas_size: [300, 300],
         choices: ['a', 'b', 'c'],
         button_html: ['This is more A', 'This is more B', 'They are the same'],
         stimulus: function(c) {
             Morphfunction(c, jsPsych.timelineVariable('radius_b'));
         },
         response_ends_trial: true,
         data: {
                 task: 'response',
                 correct_response: jsPsych.timelineVariable('correct_response'),
                 correct: 'response' == jsPsych.timelineVariable('correct_response'),
             },
       };

       var learn_C_2b = {
          type: jsPsychCanvasKeyboardResponse,
          canvas_size: [300, 300],
          stimulus: function(c) {
              Morphfunction(c, jsPsych.timelineVariable('radius_b'));
          },
          prompt: jsPsych.timelineVariable('name_b'),
          response_ends_trial: true,
          data: {
                  task: 'response',
                  correct_response: jsPsych.timelineVariable('correct_response'),
                  prompt: jsPsych.timelineVariable('name_b')
              },
          on_finish: function(data){
                  // Score the response as correct or incorrect.
                  if(jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)){
                    data.wrong = false;
                  } else {
                    data.wrong = true;
                  }
                }
        };

        var looped_C_2 = {
          timeline: [learn_A_2a, learn_C_2b],
          loop_function: function(data){
            if (jsPsych.data.get().last(1).values()[0].wrong){
              alert('Nah, let us try again!');
              return true;
              //jsPsych.resumeExperiment(learn_A_2b); // Resume the experiment
            } else{
              alert('Yes! Great job!');
              return false;
            }
          }
        };



      /* define learning procedure*/
      // Block I: learning (passive + active)
      var learn_procedure_1 = {
        timeline: [instruction_break, learn_A_1a, learn_A_1b],
        timeline_variables:learn_stimuli_a1,
      };
      var learn_procedure_2 = {
        timeline: [instruction_break,looped_A_2],
        timeline_variables: learn_stimuli_a2,
        randomize_order: true,
      };
      // Block II: testing
      var test_procedure_1 = {
         timeline: [instruction_break, test_a, test_b],
         timeline_variables: test_stimuli_1,
         randomize_order: true,
       };
       // Block III: learning (passive + active)
       var learn_procedure_3 = {
         timeline: [instruction_break, learn_A_1a, learn_A_1b],
         timeline_variables:learn_stimuli_c1,
       };
       var learn_procedure_4 = {
         timeline: [instruction_break,looped_C_2],
         timeline_variables: learn_stimuli_c2,
         randomize_order: true,
       };
       // Block IV: testing
       var test_procedure_2 = {
          timeline: [instruction_break, test_a, test_b],
          timeline_variables: test_stimuli_2,
          randomize_order: true,
        };



    /*set the structure*/
    var timeline = [];

    timeline.push(welcome);
    /*block1*/
    timeline.push(instruction_1);
    timeline.push(learn_procedure_1);
    timeline.push(instruction_2);
    timeline.push(learn_procedure_2);
    timeline.push(instruction_3);
    timeline.push(test_procedure_1);
    timeline.push(instruction_4);
    timeline.push(learn_procedure_3);
    timeline.push(instruction_5);
    timeline.push(learn_procedure_4);
    timeline.push(instruction_6);
    timeline.push(test_procedure_2);

    /* start the experiment */
    jsPsych.run(timeline);
  </script>
</html>
